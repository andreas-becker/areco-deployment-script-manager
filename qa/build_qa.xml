<?xml version="1.0"?>
<project name="ant_qa" default="qa" basedir=".">
	
	<property name="dir_qa" value="${basedir}/qa"/>
	<property name="dir_qa_reports" value="${basedir}/qa_reports"/>
	<property name="dir_pmd_home" value="${dir_qa}/pmd-bin-5.1.3"/>
	<!-- If you change the verion, you must change the download url -->
	<property name="dir_findbugs_home" value="${dir_qa}/findbugs-3.0.0"/>
	<property name="dir_findbugs_donwload_url" value="http://downloads.sourceforge.net/project/findbugs/findbugs/3.0.0/findbugs-noUpdateChecks-3.0.0.zip"/>
	<property name="dir_findbugs_donwload_file" value="${dir_qa}/findbugs.zip"/>
	
	
	<fileset dir="${dir_hybris_bin}" id="fileset_src">
		<include name="custom/*/src/**/*.java"/>
		<include name="custom/*/web/src/**/*.java"/>
		<include name="custom/*/hmc/src/**/*.java"/>
		<include name="custom/*/testsrc/**/*.java"/>
		<include name="custom/*/web/testsrc/**/*.java"/>
		<include name="custom/*/hmc/testsrc/**/*.java"/>
	</fileset>
	
	<fileset dir="${dir_hybris_bin}" id="fileset_bin">
		<include name="custom/*/classes/"/>
		<include name="custom/*/web/webroot/WEB-INF/classes/"/>
		<include name="custom/*/hmc/classes/**/"/>
	</fileset>
	
	<fileset dir="${dir_hybris_bin}" id="fileset_hybris_bin">
		<include name="custom/**/lib/*.jar"/>		
		<include name="platform/ext/*/bin/*.jar"/>
		<include name="platform/ext/*/lib/*.jar"/>
		<include name="platform/ext/*/classes/**/*.class"/>
		<include name="platform/ext/*/web/webroot/WEB-INF/classes/**/*.class"/>
		<include name="platform/ext/*/web/webroot/WEB-INF/bin/*.jar"/>
		<include name="platform/ext/*/hmc/classes/**/*.class"/>
		<include name="platform/ext/*/hmc/bin/*.jar"/>
		<include name="platform/bootstrap/bin/*.jar"/>
		<include name="platform/tomcat-6/lib/*.jar"/>
	</fileset>
	
	<target name="qa" depends="qa_clean, findbugs, pmd" description="Runs Findbugs and PMD" />
	
	<target name="qa_clean" description="Cleans the directory with the QA reports">
		<delete dir="${dir_qa_reports}"/>
		<mkdir dir="${dir_qa_reports}"/> <!-- PMD requires an existent directory -->
	</target>
	
	<target name="findbugs" depends="findbugs.install, build" description="Runs Findbugs">
		 <taskdef name="findbugs" classname="edu.umd.cs.findbugs.anttask.FindBugsTask">
				<classpath>
					<fileset dir="${dir_findbugs_home}/lib/">
						<include name="*.jar"/>
					</fileset>
				</classpath>
		</taskdef>
		<!-- Any violation must break the build -->
		<findbugs home="${dir_findbugs_home}"
			  reportLevel="low"
              output="html"
              outputFile="${dir_qa_reports}/findbugs_report.html"
              effort="max"
              failOnError="true"
              excludeFilter="${dir_qa}/findbugs_excluded_classes.xml"
              warningsProperty="findbugsFailure">
			<sourcePath path="${basedir}/src/java" />
			<fileset refid="fileset_bin"/>
			<auxClasspath>
                <fileset refid="fileset_hybris_bin" />
            </auxClasspath>
		</findbugs>
		<!-- Fail on any warning -->
		<fail if="findbugsFailure" />
	</target>
	
	 <target name="findbugs.check.installation" >
        <available property="findbugs.available"
            file="${dir_findbugs_home}"
            type="dir"/>
    </target>
	
	
	<target name="findbugs.install" description="Downloads and installs Findbugs"
        unless="findbugs.available"
		depends="findbugs.check.installation">
		<get src="${dir_findbugs_donwload_url}" 
			dest="${dir_findbugs_donwload_file}" 
			verbose="true"
			usetimestamp="true"/>
		<unzip src="${dir_findbugs_donwload_file}" dest="${dir_qa}" failOnEmptyArchive="true" />
		<delete file="${dir_findbugs_donwload_file}"/>
	</target>
	
	<target name="pmd">
		 <taskdef name="pmd" classname="net.sourceforge.pmd.ant.PMDTask">
				<classpath>
					<fileset dir="${dir_pmd_home}/lib/">
						<include name="*.jar"/>
					</fileset>
				</classpath>
		</taskdef>
		<!-- Any violation must break the build -->
		<pmd shortFilenames="true" failonerror="true" failOnRuleViolation="true"
			rulesetfiles="${dir_qa}/pmd_ruleset.xml" >
			<sourceLanguage name="java" version="1.6"/>
			<formatter type="html" toFile="${dir_qa_reports}/pmd_report.html" toConsole="true">
			</formatter>
			<fileset refid="fileset_src"/>
		</pmd>
	</target>
 </project>
